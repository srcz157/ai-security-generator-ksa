<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AI Security Generator â€” Business Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body{margin:0;font-family:Arial,sans-serif;background:#0b0f19;color:#e5e7eb;}
    .wrap{max-width:1100px;margin:0 auto;padding:20px;}
    .grid{display:grid;gap:16px;}
    .cards{grid-template-columns:repeat(4,minmax(0,1fr));}
    @media(max-width:980px){.cards{grid-template-columns:repeat(2,minmax(0,1fr));}}
    @media(max-width:580px){.cards{grid-template-columns:1fr;}}
    .card{background:#121827;border:1px solid #1f2937;border-radius:16px;padding:16px;}
    .card h3{margin:0 0 6px 0;font-size:12px;text-transform:uppercase;color:#9ca3af;letter-spacing:.6px;}
    .card .value{font-size:28px;font-weight:700;}
    textarea{width:100%;background:#0f1626;color:#e5e7eb;border:1px solid #1f2937;border-radius:10px;padding:10px 12px;}
    button{background:#60a5fa;color:#0b0f19;padding:10px 14px;border:0;border-radius:10px;font-weight:700;cursor:pointer;}
    .table{width:100%;border-collapse:collapse;}
    .table th,.table td{text-align:left;padding:10px 8px;border-bottom:1px solid #1f2937;font-size:14px;}
  </style>
</head>
<body>
  <main class="wrap">
    <h1>AI Security Generator â€” Business Dashboard</h1>

    <section class="grid cards">
      <div class="card"><h3>Revenue (Today)</h3><div class="value" id="kpiRevenue">$0</div></div>
      <div class="card"><h3>Visitors (Today)</h3><div class="value" id="kpiVisitors">0</div></div>
      <div class="card"><h3>Conversion (Today)</h3><div class="value" id="kpiConv">0%</div></div>
      <div class="card"><h3>Sales (Today)</h3><div class="value" id="kpiSales">0</div></div>
    </section>

    <section class="grid" style="grid-template-columns:1fr 1fr 1fr;margin-top:16px;">
      <div class="card"><canvas id="chartRevenue" height="140"></canvas></div>
      <div class="card"><canvas id="chartVisitors" height="140"></canvas></div>
      <div class="card"><canvas id="chartSources" height="140"></canvas></div>
    </section>

    <section class="card" style="margin-top:16px;">
      <h3 style="margin:0 0 12px 0;font-size:14px;text-transform:none;color:#d1d5db;">Recent Sales</h3>
      <table class="table" id="salesTable">
        <thead><tr><th>Date</th><th>Product</th><th>Price</th><th>Source</th></tr></thead>
        <tbody></tbody>
      </table>
    </section>

    <section class="card" style="margin-top:16px;">
      <label for="dataArea">Paste data JSON or use Auto-Fetch (below)</label>
      <textarea id="dataArea" rows="10"></textarea>
      <div style="margin-top:8px;display:flex;gap:8px;justify-content:flex-end;flex-wrap:wrap;">
        <button id="loadSample">Load sample data</button>
        <button id="updateBtn">Update dashboard</button>
        <button id="autoFetch">ðŸ”„ Auto-Fetch Live Data</button>
      </div>
    </section>
  </main>

  <script>
    const HF_SPACE = "https://huggingface.co/api/spaces/SRCZ/AI-Security-Generator";
    const LS_KEY = "gumroad_token";
    let chartRev, chartVis, chartSrc;

    function $(id){return document.getElementById(id);}
    function fmt(n){return Intl.NumberFormat('en-US',{maximumFractionDigits:2}).format(n||0);}

    function upsertTable(rows){
      const tbody=$("salesTable").querySelector("tbody");
      tbody.innerHTML="";
      rows.slice().reverse().forEach(r=>{
        const tr=document.createElement("tr");
        tr.innerHTML=`<td>${r.date}</td><td>${r.product}</td><td>$${fmt(r.price)}</td><td>${r.source}</td>`;
        tbody.appendChild(tr);
      });
    }

    function updateKPIs(kpi){
      $("kpiRevenue").textContent=`$${fmt(kpi.revenue)}`;
      $("kpiVisitors").textContent=fmt(kpi.visitors);
      $("kpiConv").textContent=`${fmt(kpi.conversion)}%`;
      $("kpiSales").textContent=fmt(kpi.sales);
    }

    function updateCharts(series){
      const labels=series.days||[];
      const revenue=series.revenue||[];
      const visitors=series.visitors||[];
      const sources=series.sources||{};

      if(chartRev)chartRev.destroy();
      chartRev=new Chart($("chartRevenue").getContext("2d"),{
        type:"line",
        data:{labels,datasets:[{label:"Revenue ($)",data:revenue,borderColor:"#60a5fa"}]},
        options:{plugins:{legend:{display:false}},scales:{x:{grid:{color:"#1f2937"}},y:{grid:{color:"#1f2937"}}}}
      });

      if(chartVis)chartVis.destroy();
      chartVis=new Chart($("chartVisitors").getContext("2d"),{
        type:"bar",
        data:{labels,datasets:[{label:"Visitors",data:visitors,backgroundColor:"#60a5fa"}]},
        options:{plugins:{legend:{display:false}},scales:{x:{grid:{color:"#1f2937"}},y:{grid:{color:"#1f2937"}}}}
      });

      if(chartSrc)chartSrc.destroy();
      chartSrc=new Chart($("chartSources").getContext("2d"),{
        type:"doughnut",
        data:{labels:Object.keys(sources),datasets:[{data:Object.values(sources),backgroundColor:["#60a5fa","#22c55e","#fbbf24","#ef4444"]}]},
        options:{plugins:{legend:{position:"bottom"}}}
      });
    }

    function applyData(json){
      const data=JSON.parse(json);
      updateKPIs(data.kpi||{});
      updateCharts(data.series||{});
      upsertTable(data.sales||[]);
    }

    async function fetchGumroadStats(token){
      const res=await fetch(`https://api.gumroad.com/v2/sales?access_token=${token}`);
      const data=await res.json();
      if(!data.success)throw new Error("Invalid token");
      let revenue=0,sales=0;const rows=[];
      data.sales.forEach(s=>{
        revenue+=s.price/100;
        sales++;
        rows.push({
          date:new Date(s.created_at).toISOString().split("T")[0],
          product:s.product_name,
          price:s.price/100,
          source:"Gumroad"
        });
      });
      return{revenue,sales,rows};
    }

    async function fetchHFStats(){
      const res=await fetch(HF_SPACE);
      const data=await res.json();
      const visitors=(data.likes||0)+(data.views||0)+(data.siblings?.length||0)*10;
      return{visitors,likes:data.likes||0,updated:data.lastModified||"N/A"};
    }

    async function autoFetch(){
      let token=localStorage.getItem(LS_KEY);
      if(!token){
        token=prompt("Enter your Gumroad Access Token:");
        if(!token)return alert("No token provided.");
        localStorage.setItem(LS_KEY,token);
      }

      try{
        const [gum, hf]=await Promise.all([
          fetchGumroadStats(token),
          fetchHFStats()
        ]);
        const conversion=hf.visitors>0?(gum.sales/hf.visitors*100).toFixed(2):0;

        const autoData={
          kpi:{revenue:gum.revenue,visitors:hf.visitors,conversion,sales:gum.sales},
          series:{
            days:["Mon","Tue","Wed","Thu","Fri","Sat","Sun"],
            revenue:[gum.revenue/7,gum.revenue/6,gum.revenue/5,gum.revenue/4,gum.revenue/3,gum.revenue/2,gum.revenue],
            visitors:[100,150,200,250,300,400,hf.visitors],
            sources:{"Gumroad":70,"HF Space":30}
          },
          sales:gum.rows
        };
        $("dataArea").value=JSON.stringify(autoData,null,2);
        applyData($("dataArea").value);
      }catch(err){
        console.error(err);
        alert("Error fetching live data. Check token or connection.");
      }
    }

    $("loadSample").addEventListener("click",()=>{
      $("dataArea").value=JSON.stringify(sample,null,2);
      applyData($("dataArea").value);
    });
    $("updateBtn").addEventListener("click",()=>{
      try{applyData($("dataArea").value);}catch(e){alert("Invalid JSON");}
    });
    $("autoFetch").addEventListener("click",autoFetch);

    // sample initial data
    const sample={
      kpi:{revenue:114,visitors:510,conversion:2.15,sales:6},
      series:{
        days:["Mon","Tue","Wed","Thu","Fri","Sat","Sun"],
        revenue:[35,42,60,75,95,110,114],
        visitors:[200,230,260,300,420,480,510],
        sources:{"SEO":46,"HF Space":28,"Gumroad Discover":21,"Reddit/HN":5}
      },
      sales:[{"date":"2025-11-02","product":"Templates Pack","price":19,"source":"Gumroad"}]
    };

    $("dataArea").value=JSON.stringify(sample,null,2);
    applyData($("dataArea").value);

    // Auto-refresh daily
    setInterval(autoFetch, 24 * 60 * 60 * 1000);
  </script>
</body>
</html>
