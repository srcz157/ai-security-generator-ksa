<script>
async function fetchGumroadStats(token) {
  try {
    const res = await fetch(`https://api.gumroad.com/v2/sales?access_token=${token}`);
    const data = await res.json();
    if (!data.success) throw new Error("Invalid token or API error");
    let revenue = 0, sales = 0;
    const rows = [];
    data.sales.forEach(s => {
      revenue += parseFloat(s.price / 100);
      sales++;
      rows.push({
        date: new Date(s.created_at).toISOString().split("T")[0],
        product: s.product_name,
        price: s.price / 100,
        source: "Gumroad"
      });
    });
    return { revenue, sales, rows };
  } catch (e) {
    console.error(e);
    alert("Failed to fetch Gumroad stats.");
    return { revenue: 0, sales: 0, rows: [] };
  }
}

async function fetchHFVisitors(spaceURL) {
  try {
    const apiURL = spaceURL.replace("https://huggingface.co/spaces/", "https://huggingface.co/api/spaces/");
    const res = await fetch(apiURL);
    const data = await res.json();
    const visitors = data.likes + data.siblings.length * 20; // rough engagement proxy
    return visitors;
  } catch (e) {
    console.warn("Hugging Face API limited:", e);
    return 0;
  }
}

async function autoUpdate() {
  const token = prompt("Enter your Gumroad access token (stored locally, never sent):");
  if (!token) return;
  const gum = await fetchGumroadStats(token);
  const visitors = await fetchHFVisitors("https://huggingface.co/spaces/SRCZ/AI-Security-Generator");

  const autoData = {
    kpi: {
      revenue: gum.revenue,
      visitors,
      conversion: (gum.sales / visitors * 100).toFixed(2),
      sales: gum.sales
    },
    series: { days: ["Mon","Tue","Wed","Thu","Fri","Sat","Sun"], revenue: [gum.revenue/7, gum.revenue/6, gum.revenue/5, gum.revenue/4, gum.revenue/3, gum.revenue/2, gum.revenue], visitors: [100,150,200,220,260,300,visitors], sources: { "Gumroad": 70, "HF Space": 30 } },
    sales: gum.rows
  };

  $("dataArea").value = JSON.stringify(autoData, null, 2);
  applyData(JSON.stringify(autoData));
}

const btn = document.createElement("button");
btn.textContent = "ðŸ”„ Auto-Fetch (Gumroad + Hugging Face)";
btn.style.cssText = "background:#22c55e;color:#fff;padding:10px 14px;border:0;border-radius:10px;font-weight:700;cursor:pointer;";
document.querySelector(".card:last-child div").appendChild(btn);
btn.addEventListener("click", autoUpdate);
</script>
